<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Andrew Ijano" href="https://example.com/rss.xml"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css"><meta name="generator" content="Astro v5.4.1"><!-- Canonical URL --><link rel="canonical" href="https://example.com/mac5856/01-test-environment/"><!-- Primary Meta Tags --><title>[Tutorial] Setting up a test environment</title><meta name="title" content="[Tutorial] Setting up a test environment"><meta name="description" content="This is the report about the first tutorial for the Linux Kernel development: Setting up a test environment for Linux Kernel Dev using QEMU and libvirt"><style>:root{--accent: #ccc;--accent-lighter: white;--background: #030303;--background-code: #24292e;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}*{font-family:Hack,monospace;margin:0;padding:0}body{padding:1em 2em;text-align:left;word-wrap:break-word;overflow-wrap:break-word;color:var(--accent);background-color:var(--background);font-size:.93em;letter-spacing:-.02em;line-height:1.5;font-weight:400;text-rendering:"optimizeLegibility"}main{max-width:calc(100% - 2em);padding:2em 0}h1,h2,h3,h4,h5,h6{margin-top:2.5em;line-height:1.2;color:var(--accent-lighter);font-weight:bolder}.prose h1,h2,h3,h4,h5,h6{margin-bottom:-.6em}h1{font-size:1.2em}h2,h3,h4,h5,h6{font-size:1.1em}strong,b{font-weight:700}a{color:var(--accent);text-decoration:"underline"}a:hover{color:var(--accent-lighter)}.prose p{margin-top:1.6em;color:(--accent)}textarea{width:100%;font-size:16px}input{font-size:1em}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;border-radius:2px;font-size:.9em;background-color:var(--background-code);color:var(--accent-lighter)}pre{padding:1.5em;border-radius:8px;margin-top:.5em;margin-bottom:2em}pre>code{all:unset;font-size:.8em}blockquote{border-left:2px solid var(--accent);padding:0 0 0 20px;margin:2em 0}hr{border:none}ul{margin-top:.5em;margin-left:1em}ol{margin-top:.5em;margin-left:2em}li{margin:.5em 0}@media (min-width: 720px){body{font-size:1em;padding:1em 5em}main{padding:1em;width:720px}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}a[data-astro-cid-eimmu3lg]{display:inline-block;color:var(--accent)}a[data-astro-cid-eimmu3lg]:hover{color:var(--accent-lighter)}.active[data-astro-cid-eimmu3lg]{font-weight:bolder;color:var(--accent-lighter)}header[data-astro-cid-3ef6ksr2]{margin:0;width:100%}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] div[data-astro-cid-3ef6ksr2]{display:flex;gap:1em}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{border-bottom:2px solid transparent;text-decoration:none}.active[data-astro-cid-3ef6ksr2]{border-bottom:2px solid transparent;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}.site-title[data-astro-cid-3ef6ksr2]{color:#fff}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}
footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;color:var(--accent);font-size:.8em;text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}body{display:flex;flex-direction:column;align-items:center}main[data-astro-cid-bvzihdzo]{max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{margin:auto;color:var(--accent)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em;color:var(--accent-lighter)}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--accent))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}@media (min-width: 680px){.prose[data-astro-cid-bvzihdzo]{width:680px;max-width:calc(100% - 2em)}}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a class="site-title" href="/" data-astro-cid-3ef6ksr2>Andrew Ijano</a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> /home </a>  <a href="/mac5856" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> /mac5856 </a>  </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2025-03-05T03:00:00.000Z"> 2025-03-05 </time> </div> <h1 data-astro-cid-bvzihdzo>[Tutorial] Setting up a test environment</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>This is the report about the first tutorial for the Linux Kernel development: <a href="https://flusp.ime.usp.br/kernel/qemu-libvirt-setup/">Setting up a test environment for Linux Kernel Dev using QEMU and libvirt</a>.</p>
<p>To develop the Linux Kernel, the first thing we need to do is setting up our test environment. This was done in several steps.</p>
<h2 id="0-installing-dependencies">0. Installing dependencies</h2>
<p>First, I needed to install all the required dependencies for it, through <code>pacman</code>, since I use the Manjaro distro.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> pacman</span><span style="color:#79B8FF"> -Syy</span><span style="color:#E1E4E8"> &#x26;&#x26; </span><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> pacman</span><span style="color:#79B8FF"> -S</span><span style="color:#9ECBFF"> qemu-full</span><span style="color:#9ECBFF"> libvirt</span><span style="color:#9ECBFF"> virt-install</span><span style="color:#9ECBFF"> guestfs-tools</span><span style="color:#9ECBFF"> wget</span></span></code></pre>
<p>QUEMU (Quick Emulator) will be used to run VMs and libvirt, as a toolkit to manage virtualization platforms, will provide tools to interact with VMs.</p>
<h2 id="1-testing-environment-directory-and-script">1. Testing environment directory and script</h2>
<p>After that, I created a separated directoy and attributed it to the <code>libvirt-qemu</code> group.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> mkdir</span><span style="color:#9ECBFF"> /home/lk_dev</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> chown</span><span style="color:#79B8FF"> -R</span><span style="color:#9ECBFF"> libvirt-qemu:libvirt-qemu</span><span style="color:#9ECBFF"> /home/lk_dev</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> chmod</span><span style="color:#79B8FF"> -R</span><span style="color:#79B8FF"> 2770</span><span style="color:#9ECBFF"> /home/lk_dev</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> usermod</span><span style="color:#79B8FF"> -aG</span><span style="color:#9ECBFF"> libvirt-qemu</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$USER</span><span style="color:#9ECBFF">"</span></span></code></pre>
<p>In this folder, I created the script that will be used to host environment variables and common functions for further developments.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">touch</span><span style="color:#9ECBFF"> '/home/lk_dev/activate.sh'</span></span>
<span class="line"><span style="color:#B392F0">chmod</span><span style="color:#9ECBFF"> +x</span><span style="color:#9ECBFF"> '/home/lk_dev/activate.sh'</span></span></code></pre>
<p>This is the initial content of the script.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6A737D">#!/usr/bin/env bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># environment variables</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#E1E4E8"> LK_DEV_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'/home/lk_dev'</span><span style="color:#6A737D"> # path to testing environment directory</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># prompt preamble</span></span>
<span class="line"><span style="color:#E1E4E8">prompt_preamble</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'(LK-DEV)'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># colors</span></span>
<span class="line"><span style="color:#E1E4E8">GREEN</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"\e[32m"</span></span>
<span class="line"><span style="color:#E1E4E8">PINK</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"\e[35m"</span></span>
<span class="line"><span style="color:#E1E4E8">BOLD</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"\e[1m"</span></span>
<span class="line"><span style="color:#E1E4E8">RESET</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"\e[0m"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># launch Bash shell session w/ env vars defined</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#79B8FF"> -e</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">GREEN</span><span style="color:#9ECBFF">}Entering shell session for Linux Kernel Dev${</span><span style="color:#E1E4E8">RESET</span><span style="color:#9ECBFF">}"</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#79B8FF"> -e</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">GREEN</span><span style="color:#9ECBFF">}To exit, type 'exit' or press Ctrl+D.${</span><span style="color:#E1E4E8">RESET</span><span style="color:#9ECBFF">}"</span></span>
<span class="line"><span style="color:#79B8FF">exec</span><span style="color:#9ECBFF"> bash</span><span style="color:#79B8FF"> --rcfile</span><span style="color:#9ECBFF"> &#x3C;(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "source ~/.bashrc; PS1=</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">\[${</span><span style="color:#E1E4E8">BOLD</span><span style="color:#9ECBFF">}\]\[${</span><span style="color:#E1E4E8">PINK</span><span style="color:#9ECBFF">}\]${</span><span style="color:#E1E4E8">prompt_preamble</span><span style="color:#9ECBFF">}\[${</span><span style="color:#E1E4E8">RESET</span><span style="color:#9ECBFF">}\] </span><span style="color:#79B8FF">\$</span><span style="color:#9ECBFF">PS1</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">")</span></span></code></pre>
<blockquote>
<p>On a side note, I tried to modify the script to use the zsh shell instead of bash, that way I could use the autocomplete capabilities of it. However, I couldn’t make it work.</p>
</blockquote>
<p>After that, I ran the script with <code>/home/lk_dev/activate.sh</code> and had it active for the following sections.</p>
<h2 id="2-configuring-a-vm">2. Configuring a VM</h2>
<p>We need a virtual machine to test our modified kernel versions. Since the tutorial focuses in the IIO (Industrial I/O) subsystem, we chose a Debian image with ARM 64-bit architecture: <code>http://cdimage.debian.org/cdimage/cloud/bookworm/daily/20250217-2026/debian-12-nocloud-arm64-daily-20250217-2026.qcow2</code>.</p>
<p>Then I followed all the steps for configuring the VM, which consists of:</p>
<ol>
<li>Downloading the disk image in a new folder;</li>
<li>Resizing the disk image <code>rootfs</code>;</li>
<li>Extracting the <code>kernel</code> and <code>initrd</code> images from the guest OS and launching the VM;</li>
<li>Using libvirt to make the VM management easier.</li>
</ol>
<h2 id="3-configuring-ssh-access">3. Configuring SSH access</h2>
<p>After successfully booting the VM, we had to configure SSH access to make file transfer easier.</p>
<blockquote>
<p>In this part I had some problems when setting up the SSH server, since the VM didn´t seem to have all the needed dependencies installed. Because of it, I had fix the firewall configurations, allowing the VM to connect to the internet and then install the needed dependencies.</p>
</blockquote>
<h2 id="4-fetching-the-list-of-loaded-modules">4. Fetching the list of loaded modules</h2>
<p>Then, with the SSH access configured, I fetched the list of loaded modules in the VM, which will be used in the following parts of the tutorial.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6A737D"># @host</span></span>
<span class="line"><span style="color:#B392F0">ssh</span><span style="color:#9ECBFF"> root@</span><span style="color:#F97583">&#x3C;</span><span style="color:#9ECBFF">VM-IP-addres</span><span style="color:#E1E4E8">s</span><span style="color:#F97583">></span></span>
<span class="line"><span style="color:#6A737D"># @VM</span></span>
<span class="line"><span style="color:#B392F0">lsmod</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> vm_mod_list</span></span></code></pre>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <a href="https://andrewijano.github.io" data-astro-cid-sz7xmlte>andrewijano.github.io</a> &copy; 2025 by Andrew Ijano is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" data-astro-cid-sz7xmlte>CC BY 4.0</a>.
</footer>  </body></html>